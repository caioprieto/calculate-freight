<!DOCTYPE html>
<html>
  <head>
    <title>Área do Aluno</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application" %>
    <%= stylesheet_link_tag "user_dashboard" %>
    <%= stylesheet_link_tag "user_settings" %>
    <link rel="icon" href="/images/icone_pagina.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <!-- Bootstrap 5 Bundle (inclui Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Select2 Bootstrap 5 Theme (opcional, melhora visual se usar Bootstrap 5) -->
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.2.2/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <!-- JS no final do body -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  </head>

  <body>
    <div class="container-dashboard">
      <div class="left-panel">
        <%= render partial: "layouts/shared/left_panel" %>
      </div>
      <div class="right-panel">
        <div class="scrollable-content scrollable">
          <div class="container-right-panel">
            <nav class="d-flex align-items-center justify-content-between px-3 py-2">
              <div class="d-flex justify-content-between align-items-center" style="width: 97%">
                <!-- Grupo esquerdo: Barra de busca -->
                <div class="d-flex align-items-center" style="gap: 20px; width: 55%">
                  <%= form_with url: user_explorar_path, method: :get, local: true, class: "search-form d-flex align-items-center" do %>
                    <input
                      type="text"
                      name="query"
                      placeholder="Qual curso está procurando?"
                      class="search-input"
                    />
                    <button type="submit" class="search-button d-flex">
                      <i class="bi bi-search fs-6 me-1"></i>
                    </button>
                  <% end %>
                </div>

                <!-- Grupo direito: Botões usuário, carrinho e notificação -->
                <div class="d-flex align-items-center" style="gap: 10px;">
                  <!-- Favoritos -->
                  <div class="position-relative">
                    <div class="btn d-flex fav-toggle" id="fav-toggle" style="cursor: pointer; position: relative; border: none">
                      <i class="bi bi-balloon-heart fs-4" style="margin-top: 7px;"></i>
                      <% if current_user.favoritos.present? %>
                        <% unless current_user.favoritos.count.zero? %>
                          <span class="bolinha position-absolute top-0" style="font-weight: 600;">
                            <span class="bolinha-span" style="margin-top: -2px;"> <%= current_user.favoritos.count %></span>
                          </span>
                        <% end %>
                      <% end %>
                    </div>
                    <%= render partial: "layouts/shared/modal_favoritos" %>
                  </div>

                  <!-- Carrinho -->
                  <div class="position-relative ms-1">
                    <div class="btn cart-toggle" id="cart-toggle" style="cursor: pointer; position: relative; border: none">
                      <i class="bi bi-cart2 fs-4"></i>
                      <% if @cart.present? %>
                        <% unless @cart.cursos.count.zero? %>
                          <span class="bolinha position-absolute top-0" style="font-weight: 600;">
                            <span class="bolinha-span" style="margin-top: -2px;"> <%= @cart.cursos.count %></span>
                          </span>
                        <% end %>
                      <% end %>
                    </div>
                    <%= render partial: "layouts/shared/modal_cart" %>
                  </div>

                  <!-- Notificação -->
                  <div class="position-relative me-2">
                    <div class="btn notify-toggle" id="notify-toggle" style="cursor: pointer; position: relative; border: none">
                      <i class="bi bi-bell fs-4"></i>
                      <% unless current_user.notifications.where(read: false, painel: "user").count.zero? %>
                        <span class="bolinha fs-6 position-absolute top-0" style="font-weight: 600;">
                          <span class="bolinha-span"> <%= current_user.notifications.where(read: false, painel: "user").count %></span>
                        </span>
                      <% end %>
                    </div>
                    <%= render partial: "layouts/shared/modal_notify" %>
                  </div>

                  <!-- BOTÃO DO ÚSUARIO -->
                  <div class="user-dropdown">
                    <button class="user-dropdown-button" aria-label="Menu do usuário">
                      <i class="bi bi-person-circle user-icon fs-4"></i>
                      <span class="email-text"><%= current_user.nome.upcase %></span>
                    </button>

                    <div class="user-dropdown-menu">
                      <div class="arrow-up"></div>
                      <div class="d-flex">
                        <i class="bi bi-mortarboard fs-5" style="margin-top: 3px; margin-left: 8px; margin-right: 1px;"></i>
                        <span style="font-weight: 600; padding: 10px; font-size: 14px">Área do Aluno</span>
                      </div>
                      <hr style="margin: 0;">
                      <%= link_to root_path, class: "d-flex" do %>
                        <i class="bi bi-house fs-6" style="margin-right: 10px; margin-top: -1px;"></i>
                        <span style="font-size: 14px;">Voltar para Home</span>
                      <% end %>
                      <%= link_to '#', onclick: 'logout(); return false;', class: "d-flex text-danger" do %>
                        <i class="bi bi-box-arrow-left fs-6" style="margin-right: 10px; margin-top: 0px;"></i>
                        <span style="font-size: 14px;">Sair</span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </nav>

            <% if params[:query].present? %>
              <div class="search-label px-3 rounded text-dark" style="font-size: 14px; margin-left: 7px; width: 100%; font-weight: 500; margin-top: 5px; margin-bottom: 2px;">
                Resultado da busca por: "<strong class="text-danger"><%= params[:query] %></strong>"
              </div>
            <% end %>

            <%= yield %>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("cart-toggle");
    const dropdown = document.getElementById("cart-dropdown");

    let timeout;

    toggle.addEventListener("click", () => {
      clearTimeout(timeout);
      if (dropdown.style.display === "none" || dropdown.style.display === "") {
        dropdown.style.display = "block";
      } else {
        dropdown.style.display = "none";
      }
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("notify-toggle");
    const dropdown = document.getElementById("notify-modal");

    let timeout;

    toggle.addEventListener("click", () => {
      clearTimeout(timeout);
      if (dropdown.style.display === "none" || dropdown.style.display === "") {
        dropdown.style.display = "block";
      } else {
        dropdown.style.display = "none";
      }
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("fav-toggle");
    const dropdown = document.getElementById("favoritos-dropdown");

    let timeout;

    toggle.addEventListener("click", () => {
      clearTimeout(timeout);
      if (dropdown.style.display === "none" || dropdown.style.display === "") {
        dropdown.style.display = "block";
      } else {
        dropdown.style.display = "none";
      }
    });
  });

  function logout() {
    fetch("/users/sign_out", {
      method: "DELETE",
      headers: {
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
        "Content-Type": "application/json"
      },
      credentials: "same-origin"
    }).then(() => {
      window.location.href = "/";
    }).catch((error) => {
      console.error("Erro ao fazer logout:", error);
    });
  }
</script>
